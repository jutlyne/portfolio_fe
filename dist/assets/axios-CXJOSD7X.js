import{a as k,H as h}from"./axios--ry0FeSQ.js";import{v as T,r as l}from"./index-V-ixwPPj.js";import{u as R}from"./vue3-cookies-obZ_cbEp.js";import{b as y}from"./ant-design-vue-xZZJ8OSi.js";const d=async(e,t=!1)=>{try{return{result:await e,errorResult:null}}catch(s){return{result:null,errorResult:s}}},S=async(e,t={},s=null,a=!1)=>{const{result:n,errorResult:i}=await d(e,a);return n!==null&&typeof n.data<"u"?n.data:(typeof s=="function"&&(s==null||s(i)),t)},P=async e=>await d(o.post("/auth/login",{...e,expiresInMins:1})),U=async()=>await S(o.get("/auth/me")),I=async e=>await d(o.post("/auth/refresh",{refreshToken:e,expiresInMins:1}));let p=!1,f=[];const w="https://dummyjson.com/",{cookies:u}=R(),A=e=>{f.map(t=>t(e)),f=[]},$=e=>{f.push(e)},x=()=>{const e=localStorage.getItem("adminAccessToken"),t=u.get("adminAccessTokenSignature");return e&&t?`${e}.${t}`:""},E=()=>{const e=localStorage.getItem("adminRefreshToken"),t=u.get("adminRefreshTokenSignature");return e&&t?`${e}.${t}`:""},o=k.create({baseURL:w,headers:{Accept:"application/json","Content-Type":"multipart/form-data",Authorization:`Bearer ${x()}`}}),v=async e=>{var a,n,i;const{config:t}=e,s=((a=e.response)==null?void 0:a.status)??h.InternalServerError;if(T.includes(s)&&await l.push({name:"error",params:{statusCode:s}}),s==h.Unauthorized&&!t._retry){if(p)return new Promise(c=>{$(r=>{t.headers.Authorization=`Bearer ${r}`,c(o(t))})});{p=!0,t._retry=!0;const c=E(),{result:r,errorResult:g}=await I(c);if((n=r==null?void 0:r.data)!=null&&n.token&&((i=r==null?void 0:r.data)!=null&&i.refreshToken))return z(r.data.token,r.data.refreshToken,t,!0),A(r.data.token),!0;g&&y.loading("Vui lòng đăng nhập lại!",1.5).then(async()=>{B(),await l.push({name:"admin.login"})})}}return Promise.reject(e)},z=(e,t,s,a=!1)=>{let n=new Date;n.setMonth(n.getMonth()+1),a&&(n=new Date(u.get("adminRefreshTokenExpiresIn"))),m(e,"adminAccessToken","adminAccessTokenSignature"),m(t,"adminRefreshToken","adminRefreshTokenSignature",n),u.set("adminRefreshTokenExpiresIn",n.toString(),n),o.defaults.headers.Authorization=`Bearer ${e}`,s&&(s.headers.Authorization=`Bearer ${e}`,o(s))},m=(e,t,s,a)=>{const[n,i,c]=e.split(".");n&&i&&c&&(localStorage.setItem(t,`${n}.${i}`),u.set(s,c,a))},B=()=>{localStorage.clear(),u.keys().map(e=>{u.remove(e)})};o.interceptors.request.use(e=>e);o.interceptors.response.use(e=>e,v);export{o as a,d as b,B as c,z as d,U as g,P as l,S as s};
